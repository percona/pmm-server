	gzip on;
	etag on;
	map $http_upgrade $connection_upgrade {
		default upgrade;
		'' close;
	}
# force redirect to https
#        server {
#                listen 80 default_server;
#	        listen [::]:80 default_server;
#	        server_name _;
#	        return 301 https://$host$request_uri;
#        }


	upstream managed-grpc {
		server 127.0.0.1:7771;
		keepalive 32;
		keepalive_requests 100;
		keepalive_timeout 75s;
	}

	upstream managed-json {
		server 127.0.0.1:7772;
		keepalive 32;
		keepalive_requests 100;
		keepalive_timeout 75s;
	}

	server {
		listen                  80;
		listen			443 ssl http2;
		server_name		_;
		server_tokens		off;

		# workaround CVE-2017-7529
		max_ranges		1;
		# allow huge requests
		large_client_header_buffers	128 64k;

		ssl_certificate		/srv/nginx/certificate.crt;
		ssl_certificate_key	/srv/nginx/certificate.key;
		ssl_trusted_certificate	/srv/nginx/ca-certs.pem;
		ssl_dhparam		/srv/nginx/dhparam.pem;

		# Authentification
		set			$setup_type ovf-ami;

		if (-f /srv/nginx/.htpasswd) {
			set		$realm on;
			set		$setup_type "${setup_type}-protected";
		}
		if ($setup_type = "ovf-ami") {
			rewrite		^/$ $scheme://$http_host/password-page/ permanent;
		}
		if ($setup_type ~ "-protected") {
			rewrite		^/password-page $scheme://$http_host/ permanent;
		}

		root			/usr/share/pmm-server/landing-page;

		# Grafana
		rewrite				^/$ $scheme://$http_host/graph/ permanent;
		rewrite				^/graph$ /graph/;
		location /graph {
			proxy_cookie_path	/ "/;";
			proxy_pass		http://127.0.0.1:3000;
			rewrite			^/graph/(.*) /$1 break;
			proxy_read_timeout	600;
		}


		# Prometheus
		location /prometheus {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/auth/keys;
			proxy_pass		http://127.0.0.1:9090;
			proxy_read_timeout	600;
		}

		# QAN App
		location /qan {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/org;
			alias			/usr/share/percona-qan-app;
			try_files		$uri /index.html break;
			add_header		X-Frame-Options SAMEORIGIN;
		}

		# QAN API
		rewrite				^/qan-api$ /qan-api/;
		location /qan-api {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/org;
			proxy_pass		http://127.0.0.1:9001;
			rewrite			^/qan-api/(.*) /$1 break;
			proxy_set_header	Host $http_host;
			proxy_http_version	1.1;
			proxy_set_header	Upgrade $http_upgrade;
			proxy_set_header	Connection $connection_upgrade;
			proxy_read_timeout	86400;
		}

		# Orchestrator
		location /orchestrator {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/auth/keys;
			proxy_pass		http://127.0.0.1:4000;
		}

		location /collect_info {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/auth/keys;
			root 			/srv/collect_info;
			autoindex 		on;
		}

		location /password-page {
			alias /usr/share/pmm-server/password-page;
			try_files		$uri /index.html break;
		}

		# Configurator
		location /configurator {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/auth/keys;
			proxy_pass		http://127.0.0.1:7777;
			proxy_read_timeout	86400;
		}

		# pmm-managed gRPC APIs
		location /agent. {
			grpc_pass grpc://managed-grpc;
		}
		location /inventory. {
			grpc_pass grpc://managed-grpc;
		}

		# pmm-managed Invnetory JSON APIs
		location /v1/inventory/ {
			proxy_pass http://managed-json/v1/inventory/;
		}

		# TODO remove
		location /managed {
                # auth temporary disabled PMM-2912
                #       auth_request            /graph/api/auth/keys;
			proxy_pass		http://127.0.0.1:7772;
			rewrite			^/managed/(.*) /$1 break;
		}

		# PMM-2004 health endpoint
		# TODO rework
		rewrite				^/ping$ /managed/v1/version;
		location /managed/v1/version {
			auth_basic		off;
			proxy_pass		http://127.0.0.1:7772;
			rewrite			^/managed/(.*) /$1 break;
		}

		# QAN API 2
		# TODO rework
		location / {
			grpc_pass grpc://127.0.0.1:9911;
		}

	}
